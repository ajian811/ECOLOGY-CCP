<!-- script代码，如果需要引用js文件，请使用与HTML中相同的方式。 -->
<script type="text/javascript">
    /*
     *  TODO
     *  请在此处编写javascript代码
     */
    var hang_number0;
    var shipno;
    jQuery(document).ready(function() {
        var sfyg = jQuery("#field8087").val();
        if (sfyg.length > 0) {
            if (sfyg == 0) {
                jQuery(".wg").show();
                jQuery(".yg").hide();
            } else {
                jQuery(".yg").show();
                jQuery(".wg").hide();
            }
        } else {
            jQuery(".yg").hide();
            jQuery(".wg").hide();
        }

        var sfyyf = jQuery("#field8088").val();
        if (sfyyf.length > 0) {
            console.log(sfyyf);
            if (sfyyf == 1) {
                jQuery(".yyf").show();
            } else {
                jQuery(".yyf").hide();
            }
        }

        checkCustomize = function() {
            var sfzf = jQuery("#field13403 option:selected").val();
            var sfyf = jQuery("#field8088").val();
            var fxlrow = jQuery("#nodesnum3").val();
            var zyf = jQuery("#field8121").val();
            if (sfzf == "1") {
                return true;
            }
            /*
            * 是否有运费=YES的情况，如总运费=0 、 没有辅路线明细、明细中的成本中心为空，
            * 则不允许提交的校验
            *
            * */
            if (sfyf == 1) {
                if(fxlrow <= 0) {
                    alert("有运费时，辅线路明细不能为空！");
                    return false;
                }
                if(!(zyf>0)){
                    alert("有运费时，总运费需大于0！");
                    return false;
                }
                var submitdtlid2=jQuery("#submitdtlid2").val();
                if(submitdtlid2.length>0){
                    var submitdtlid2s=submitdtlid2.split(",");
                    for(var i=0;i<submitdtlid2s.length;i++){
                        var index=submitdtlid2s[i];
                        var cbzx=jQuery("#field9360_"+index).val();
                        if(cbzx.length==0){
                            alert("有运费时，产品明细的成本中心不能为空！");
                            return false;
                        }
                    }
                }

            }

                return checkALL();

        }


        $("#field11001_browserbtn").bind('click', function() {
            if ($("#field8241").val() == '') {
                alert("没有记录选择，请选择承运商名称！");
                return;
            } else if ($("#field8107").val() == '') {
                alert("没有记录选择，请选择车型！");
                return;
                /*         } else if ($("#field8110").val() == '') {
                alert("没有记录选择，请选择吨位！");
                return;
*/
            } else if ($("#field8111").val() == '') {
                alert("没有记录选择，请选择预计运输日期！");
                return;
            } else if ($("#field8441").val() == '') {
                alert("没有记录选择，请选择运费模式！");
                return;
            } else if ($("#field8223").val() == '') {
                alert("没有记录选择，请选择主路线！");
                return;
            } else if ($("#field8261").val() == '') {
                alert("没有记录选择，请选择运输模式！");
                return;
            }
        });
        var html = "<input type='button' value='生成辅线路' class='middle e8_btn_top_first' id='accquire' />";
        $("#needButton").append(html);
        $("#accquire").click(function() {
            accquireYF();
        });
        var html = "<input type='button' value='重新生成辅线路' class='middle e8_btn_top_first' id='refreshYF' />";
        $("#refresh").append(html);
        $("#refreshYF").click(function() {
            refreshYF();
        });



        //是否有运费联动
        jQuery("#field8088").bindPropertyChange(function() {
            var sfyyf = jQuery("#field8088").val();
            var sffz = jQuery("#field13439").val();
            if (sffz == -1) {
                EliminateFieldVal();
            }
            if (sfyyf.length > 0) {
                console.log(sfyyf);
                if (sfyyf == 1) {
                    jQuery(".yyf").show();
                } else {
                    jQuery(".yyf").hide();
                }
            } else {
                delRowFunmd0(3);
            }
        });

        //是否有柜联动
        jQuery("#field8087").bindPropertyChange(function() {
            var sfyg = jQuery("#field8087").val();
            if (sfyg.length > 0) {
                if (sfyg == 0) {
                    delRowFunmd0(0);
                    delRowFunmd0(2);
                    delRowFunmd0(3);
                    jQuery(".wg").show();
                    jQuery(".yg").hide();
                    jQuery("#field13765span>span").children("span").click();


                } else {
                    jQuery("#field13766span>span").children("span").click();

                    delRowFunmd0(0);

                    delRowFunmd0(2);
                    delRowFunmd0(3);
                    jQuery(".yg").show();
                    jQuery(".wg").hide();
                }
            } else {
                jQuery(".yg").hide();
                jQuery(".wg").hide();
                delRowFunmd0(0);
                delRowFunmd0(1);
                delRowFunmd0(2);
            }
        });

        //有柜理货编号查询联动
        jQuery("#field13765").bindPropertyChange(function() {
            delRowFunmd0(0);
            delRowFunmd0(2);
            var ghs0 = jQuery("#field13765").val();
            if (ghs0.length == 0) {
                return;
            }

            var ghs = ghs0.split(",");
            // var i = 0;
            // jQuery("#field13765span").find('a').each(function() {
            //     ghs[i] = jQuery(this).html();
            //     i++;
            // });
            console.log(ghs);
            // var lhbh=jQuery("#field13765").val();
            if (ghs.length == 0) {
                return;
            }
            var gh = new Array();

            jQuery.ajax({
                url: "/sapjsp/zxjh.jsp",
                data: {
                    "ghs": ghs,
                    "type": "yg"
                },
                type: "POST",
                dataType: "json",
                success: function(responseJSON) {
                    if (responseJSON) {
                        console.log(JSON.stringify(responseJSON));
                        jQuery.each(responseJSON.arr1, function(i, item) {

                            addRow2(2);
                            hang_number0 = parseInt(jQuery("#indexnum2").val()) - 1;
                            // if (jgrq = '' || jgrq > item.CLOSEDATE) {
                            //     fillMX(13475, item.CLOSEDATE); //结关日期
                            // }
                            fillMX(8147, item.SHIPADVICENO); //SHIPPING
                            shipno = item.SHIPADVICENO;
                            fillMX(8148, item.PROCATEGORY); //产品
                            fillMX(10663, item.DELIVERYNO); //交运单号
                            fillMX(10664, item.DELIVERYITEM); //项次
                            fillMX(8149, item.LFIMG); //数量
                            fillMX(9337, item.AUART); //订单类型
                            fillMX(9338, item.ORDERITEM); //销售订单项次
                            fillMX(9339, item.SALEORDER); //销售订单号
                            fillMX(9340, item.SPART); //产品组
                            fillMX(9341, item.STOCKNO); //物料号
                            fillMX(9342, item.STOCKDESC); //物料描述
                            fillMX(9344, item.SHIPNUM); //已运载量
                            fillMX(9346, item.SALEUNIT); //单位代码
                            fillMX(9347, item.LOCATION); //库位代码
                            fillMX(9349, item.LGOBE); //库存位置
                            fillMX(9350, item.VKAUS); //包装性质
                            fillMX(9351, item.KUNNR); //送达方
                            fillMX(9352, item.SHIPTO); //送达方名称
                            fillMX(9353, item.SHIPTOADDR); //送达地址描述
                            fillMX(9355, item.KUNAG); //售达方--售达方简码
                            fillMX(9356, item.SOLDTO); //售达方名称
                            fillMX(9360, item.COSTCENTER); //成本中心

                            fillMX(10822, item.ZWEIGHT); //包装重量
                            fillMX(10921, item.NTGEW); //净重
                            if (item.VKAUS == 'Z01') { //9350
                                var bczz = item.ZWEIGHT;
                            } else {
                                var bczz = item.ZWEIGHT * item.sl;
                            }

                            fillMX(13663, bczz); //包材总重量
                            var bccpjz;
                            bccpjz=item.NTGEW / item.LFIMG * item.sl;
                            fillMX(13674, bccpjz); //本次产品数量
                            jQuery("#field10822_" + hang_number0).trigger("change");

                            fillMX(9348, item.REMARK1); //单位描述
                            fillMX(9343, item.sl); //计划装卸量
                            fillMX(13883, item.gbm); //柜编码
                            fillMX(13884, item.ph); //批号


                            jQuery("#field10921_" + hang_number0).change();

                            calSum(2);

                            // gh.push(item.gh);

                            var closedate = item.CLOSEDATE;
                            var gjrq = jQuery("#field13475").val();
                            console.log("获得关结日期：" + closedate);
                            if (closedate.length > 0) {
                                if (gjrq.length == 0 || gjrq < closedate) {
                                    jQuery("#field13475").val(closedate);
                                    jQuery("#field13475span").html(closedate);
                                }
                            }


                            //明细1赋值--柜号


                        });

                        // console.log("gh:"+gh);
                        // var gh1=unique5(gh);
                        //
                        // for (var j=0;j<gh1.length;j++) {
                        //     var gh0=gh1[j];
                        //     addRow0(0);
                        //     hang_number0 = parseInt(jQuery("#indexnum0").val()) - 1;
                        //
                        //     fillMX(8141, gh0);//计划装卸量
                        // }
                        jQuery.each(responseJSON.arr2, function(i, item) {
                            addRow0(0);
                            hang_number0 = parseInt(jQuery("#indexnum0").val()) - 1;
                            fillMX(8141, item.gh);
                            fillMX(13776, item.shipping);
                            fillMX1(13888, item.gh2);
                            fillMX(13657, item.xh);
                            fillMX(14330, item.lhsqid);

                        })

                    }


                }

            });


        })


        //无柜理货编号查询联动
        jQuery("#field13766").bindPropertyChange(function() {

            delRowFunmd0(2);
            delRowFunmd0(0);
            var ghs0 = jQuery("#field13766").val();
            if (ghs0.length == 0) {
                return;
            }
            var ghs = ghs0.split(",");

            console.log(ghs);



            jQuery.ajax({
                url: "/sapjsp/zxjh.jsp",
                data: {
                    "ghs": ghs,
                    "type": "wg"
                },
                type: "POST",
                dataType: "json",
                success: function(responseJSON) {
                    if (responseJSON) {
                        console.log(JSON.stringify(responseJSON));
                        jQuery.each(responseJSON.arr1, function(i, item) {
                            addRow2(2);
                            hang_number0 = parseInt(jQuery("#indexnum2").val()) - 1;
                            //if (jgrq = '' || jgrq > item.CLOSEDATE) {
                            //fillMX(13475, item.CLOSEDATE); //结关日期
                            //}
                            fillMX(8147, item.SHIPADVICENO); //SHIPPING
                            fillMX(8148, item.PROCATEGORY); //产品
                            fillMX(10663, item.DELIVERYNO); //交运单号
                            fillMX(10664, item.DELIVERYITEM); //项次
                            fillMX(8149, item.LFIMG); //数量
                            fillMX(9337, item.AUART); //订单类型
                            fillMX(9338, item.ORDERITEM); //销售订单项次
                            fillMX(9339, item.SALEORDER); //销售订单号
                            fillMX(9340, item.SPART); //产品组
                            fillMX(9341, item.STOCKNO); //物料号
                            fillMX(9342, item.STOCKDESC); //物料描述
                            fillMX(9344, item.SHIPNUM); //已运载量
                            fillMX(9346, item.SALEUNIT); //单位代码
                            fillMX(9347, item.LOCATION); //库位代码
                            fillMX(9349, item.LGOBE); //库存位置
                            fillMX(9350, item.VKAUS); //包装性质
                            fillMX(9351, item.KUNNR); //送达方
                            fillMX(9352, item.SHIPTO); //送达方名称
                            fillMX(9353, item.SHIPTOADDR); //送达地址描述
                            fillMX(9355, item.KUNAG); //售达方--售达方简码
                            fillMX(9356, item.SOLDTO); //售达方名称
                            fillMX(9360, item.COSTCENTER); //成本中心

                            fillMX(10822, item.ZWEIGHT); //包装重量
                            fillMX(10921, item.NTGEW); //净重
                            var bczz = item.ZWEIGHT * item.sl;
                            fillMX(13663, bczz); //包材总重量
                            if (item.VKAUS == 'Z01') { //9350
                                var bczz = item.ZWEIGHT;
                            } else {
                                var bczz = item.ZWEIGHT * item.sl;
                            }

                            var bccpjz;
                            bccpjz=item.NTGEW / item.LFIMG * item.sl;
                            fillMX(13674, bccpjz); //本次产品数量


                            fillMX(9348, item.REMARK1); //单位描述
                            fillMX(9343, item.sl); //计划运载量
                            fillMX(13883, item.gbm); //柜编码
                            fillMX(13884, item.ph); //批号
                            // jQuery("#field10921_0").trigger("change");
                            jQuery("#field10921_" + hang_number0).change();

                            // calSum(2);





                            var closedate = item.CLOSEDATE;
                            var gjrq = jQuery("#field13475").val();
                            console.log("获得关结日期：" + closedate);
                            if (closedate.length > 0) {
                                if (gjrq.length == 0 || gjrq < closedate) {
                                    jQuery("#field13475").val(closedate);
                                    jQuery("#field13475span").html(closedate);
                                }
                            }


                        });


                        jQuery.each(responseJSON.arr2, function(i, item) {
                            addRow0(0);
                            hang_number0 = parseInt(jQuery("#indexnum0").val()) - 1;
                            fillMX(8141, item.gh);
                            fillMX(13776, item.shipping);
                            fillMX1(13888, item.gh2);
                            fillMX(13657, item.xh);
                            fillMX(14330, item.lhsqid);

                        })

                    }


                }

            });

        });

    });

    function fillMX(fieldid, value) {
        jQuery("#field" + fieldid + "_" + hang_number0).val(value); //input赋值
        jQuery("#field" + fieldid + "_" + hang_number0 + "span").html(value); //span赋值

    }

    function fillMX1(fieldid, value) {
        jQuery("#field" + fieldid + "_" + hang_number0).val(value); //input赋值

    }



    function accquireYF() {
        var sfyg = $("#field8087").val(); //是否有柜
        var startCity = $("#field8098").val(); //起点城市
        var endCity = $("#field8099").val(); //终点城市
        var list = [];
        var comm = [];
        var cysjm = $("#field8105").val(); //承运商简码
        var cx = $("#field8107").val(); //车型
        // var dw = $("#field8110").val(); //吨位
        var dw = 60;
        var ysrq = $("#field8111").val(); //运输日期
        var jflx = $("#field8441").val(); //计费方式
        var yslx = $("#field8261").val(); //运输方式
        var xllx = "0";
        var cqb = $("#field8082").val(); //厂区别
        comm.push(cysjm, cx, dw, ysrq, jflx, yslx, xllx, cqb);

        for (var i = 0; i < $("#indexnum2").val(); i++) {
            if ($("#field9354_" + i).val().length == 0) {
                alert("请先选择明细表中的到达城市点！");
                return;
            }
            if ($("#field9354_" + i).val() != '' && $("#field9354_" + i).val() != null) {

                var temp = {
                    'sendName': $("#field9351_" + i).val(),
                    'sendAddress': $("#field9353_" + i).val(),
                    'midCity': $("#field9354_" + i).val()

                }
                list.push(temp);
            }
        }



        //alert(JSON.stringify(list));
        console.log("list:" + list);
        jQuery.ajax({
            url: "/weightJsp/ACCQUIRE_SO_ASSISTYF.jsp",
            data: {
                "startCity": startCity,
                "endCity": endCity,
                "list": JSON.stringify(list),
                "comm": comm
            },
            type: "POST",
            dateType: "json",
            success: function(data) {
                if (data) {
                    delRowFunmd0(3);
                    console.log(accquire.length);
                    jQuery.each(JSON.parse(data), function(i, item) {
                        addRow3(3);
                        var hang_number = parseInt(jQuery("#indexnum3").val()) - 1;
                        jQuery("#field11426_" + hang_number).val(item.sort); //城市点顺序

                        jQuery("#field11421_" + hang_number).val(item.midCity); //城市点id
                        jQuery("#field11421_" + hang_number + "span").html(item.midCity);

                        jQuery("#field11422_" + hang_number).val(item.sort); //

                        jQuery("#field11423_" + hang_number).val(item.price); //辅线路价格
                        jQuery("#field11423_" + hang_number + "span").html(item.price);

                        jQuery("#field11424_" + hang_number).val(item.tcdj); //同城单价
                        jQuery("#field11424_" + hang_number + "span").html(item.tcdj);

                        jQuery("#field11425_" + hang_number).val(item.index); //同城个数
                        jQuery("#field11425_" + hang_number + "span").html(item.index);

                        var totalPrice = parseFloat(item.index) * parseFloat(item.tcdj);
                        jQuery("#field11661_" + hang_number).val(totalPrice); //同城总价
                        jQuery("#field11661_" + hang_number + "span").html(totalPrice);
                    });
                    Dialog.alert("获取辅线路数据成功！");
                }
            },
            error: function() {
                Dialog.alert("获取辅线路数据失败！");
            }
        })
    }

    function refreshYF() {
        if ($("#indexnum3").val() - 0 <= 0) {
            alert("请先点击生成辅线路");
            return;
        }
        var startCity = $("#field8098").val(); //起点城市
        var endCity = $("#field8099").val(); //终点城市
        var list = [];
        var comm = [];
        var cysjm = $("#field8105").val(); //承运商简码
        var cx = $("#field8107").val(); //车型
        // var dw = $("#field8110").val(); //吨位
        var dw = 60;
        var ysrq = $("#field8111").val(); //运输日期
        var jflx = $("#field8441").val(); //计费方式
        var yslx = $("#field8261").val(); //运输方式
        var xllx = "0";
        var cqb = $("#field8082").val(); //厂区别
        comm.push(cysjm, cx, dw, ysrq, jflx, yslx, xllx, cqb);
        for (var i = 0; i < $("#indexnum3").val(); i++) {
            if ($("#field11426_" + i).val() != '' && $("#field11426_" + i).val() != null) {

                var temp = {
                    'sort': $("#field11426_" + i).val(), //顺序
                    'midCity': $("#field11421_" + i).val(), //城市id
                    'tcdj': $("#field11424_" + i).val(), //同城单价
                    'index': $("#field11425_" + i).val(), //同城个数

                }
                list.push(temp);
            }
        }
        jQuery.ajax({
            url: "/weightJsp/REFRESH_SO_ASSISTYF.jsp",
            data: {
                "startCity": startCity,
                "endCity": endCity,
                "list": JSON.stringify(list),
                "comm": comm
            },
            type: "POST",
            dateType: "json",
            success: function(data) {
                if (data) {
                    console.log(JSON.parse(data));
                    delRowFunmd0(3);
                    console.log(accquire.length);
                    jQuery.each(JSON.parse(data), function(i, item) {
                        addRow3(3);
                        var hang_number = parseInt(jQuery("#indexnum3").val()) - 1;
                        jQuery("#field11426_" + hang_number).val(item.sort); //城市点顺序

                        jQuery("#field11421_" + hang_number).val(item.midCity); //城市点id
                        jQuery("#field11421_" + hang_number + "span").html(item.midCity);

                        jQuery("#field11422_" + hang_number).val(item.sort); //

                        jQuery("#field11423_" + hang_number).val(item.price); //辅线路价格
                        jQuery("#field11423_" + hang_number + "span").html(item.price);

                        jQuery("#field11424_" + hang_number).val(item.tcdj); //同城单价
                        jQuery("#field11424_" + hang_number + "span").html(item.tcdj);

                        jQuery("#field11425_" + hang_number).val(item.index); //同城个数
                        jQuery("#field11425_" + hang_number + "span").html(item.index);

                        var totalPrice = parseFloat(item.index) * parseFloat(item.tcdj);
                        jQuery("#field11661_" + hang_number).val(totalPrice); //同城总价
                        jQuery("#field11661_" + hang_number + "span").html(totalPrice);
                    });
                    Dialog.alert("获取辅线路数据成功！");

                }
            },
            error: function() {
                Dialog.alert("获取辅线路数据失败！");
            }
        })
    }


    function checkALL() {
        return updateFqh();
    }
    //封签号校验
    function updateFqh() {
        var sfyg = jQuery("#field8087").val(); //是否有柜
        var submitdtlid0 = jQuery("#submitdtlid0").val().split(",");
        var jnArr = [];
        var result = false;
        var shipno = jQuery("#field9521").val(); //shipping
        for (var i = 0; i < submitdtlid0.length; i++) {
            var index = submitdtlid0[i];
            var gh = jQuery("#field8141_" + index).val(); //柜号
            var shipping = jQuery("#field13776_" + index).val(); //shipping
            // var fqh = jQuery("#field8142_" + index).val(); //封签号
            var jn = {
                "gh": gh,
                "shipno": shipping,
                "sfyg": sfyg
                // "fqh": fqh
                // "index": index
            };
            jnArr.push(jn);
        }
        console.log(JSON.stringify(jnArr));
        jQuery.ajax({
            url: "/sapjsp/zxjh.jsp",
            data: {
                "dtdata": JSON.stringify(jnArr),
                "type": "updateFqh",
                "sfyg": sfyg
            },
            type: "POST",
            async: false,
            dateType: "json",
            success: function(data) {
                var datatext = data.replace(/(^\s*)|(\s*$)/g, "");
                console.log(datatext);
                if (datatext) {
                    if (datatext == "success") {
                        console.log("数据更新成功");
                        result = true;
                    } else {
                        Dialog.alert(datatext);
                    }
                }
            }
        })
        return result;
    }



    jQuery(document).ready(function() {
        jQuery("#field13476").bindPropertyChange(function() {
            var jgrq = jQuery("#field13475").val();
            if (jgrq != null && jgrq != '') {
                jgtime();
            } else {
                jQuery("#field13477").val(0);
            }
        })
    })

    function jgtime() {
        var jjzt = jQuery("#field13476").val();
        if (jjzt < 7) {
            jQuery("#field13477").val(1);
        } else {
            jQuery("#field13477").val(0);
        }
    }
    //数组去重
    function unique5(array) {
        var r = [];
        for (var i = 0, l = array.length; i < l; i++) {
            for (var j = i + 1; j < l; j++)
                if (array[i] === array[j]) j = ++i;
            r.push(array[i]);
        }
        return r;
    }

    function EliminateFieldVal() {
        EliminateVal("field8441"); //计费模式
        EliminateVal("field8261"); //运输模式
        EliminateVal("field8262"); //排车原则
        EliminateVal("field8116"); //同城个数
        EliminateZDYVal("field8107"); //车型
        EliminateZDYVal("field8223"); //主线路
        EliminateZDYVal("field11001"); //运费价格档
    }

    function EliminateVal(fieldid) {
        jQuery("#" + fieldid + "_span").html('');
        jQuery("#" + fieldid).val('');
    }

    function EliminateZDYVal(fieldid) {
        var FieldValue = jQuery("#" + fieldid).val(); //虚拟柜号
        jQuery("#" + FieldValue).click();
    }
    jQuery(document).ready(function() {
        jQuery("#field9162").bindPropertyChange(function() { //价格档
            zjg();
        })
        jQuery("#field8441").bindPropertyChange(function() { //计费模式
            zjg();
        })
        jQuery("#field11662").bindPropertyChange(function() { //同城总运费
            zjg();
        })
        jQuery("#field8118").bindPropertyChange(function() { //辅路线总价
            zjg();
        })
    })
    /*uc 2018/02/05*/
    function zjg() {
        var jfms = parseFloat(jQuery("#field8441").val());
        var jgd = parseFloat(jQuery("#field9162").val());
        var tczf = parseFloat(jQuery("#field11662").val());
        var fxl = parseFloat(jQuery("#field8118").val());
        var zyf = 0;
        var zjz = parseFloat(jQuery("#field13667").val()); //总净重
        var jhyzljh = parseFloat(jQuery("#field13670").val()); //计划运载量合计
        console.log("jfms:"+jfms+",jgd:"+jgd+",tczf:"+tczf+",fxl:"+fxl+",jhyzlhj:"+jhyzljh+",zjz:"+zjz);
        if (jfms == 0) { //包车
            zyf = jgd + tczf + fxl;
        } else if (jfms == 1) { //计重
            zyf = jgd * zjz / 1000 + tczf + fxl;
        } else { //=2/计件
            zyf = jgd * jhyzljh + tczf + fxl;
        }
        console.log('zyf:'+zyf);
        if (isNaN(zyf)) {
            return;
        }
        jQuery("#field8121").val(zyf.toFixed(2));
        jQuery("#field8121span").html(zyf.toFixed(2));
    }
</script>
<script type="text/javascript" src="/sapjsp/util.js"></script>



